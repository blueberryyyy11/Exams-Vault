** Виртуальная память процесса. Структура виртуальной памяти, особенности и работа с физической памятью. Описание механизма клонирования памяти процесса.**

### Что такое системные вызовы

Системные вызовы (system calls) — это интерфейс между прикладными программами и ядром операционной системы. Они позволяют программам запрашивать услуги у ядра, такие как работа с файлами, управление процессами, взаимодействие с устройствами и другие операции, требующие привилегированного доступа.

### Механизм работы системных вызовов

#### Общая схема работы системного вызова:

1. **Пользовательский режим (User Mode):**
    - Программа вызывает библиотечную функцию (например, `read()` или `write()`), которая подготовлена для выполнения системного вызова.
2. **Переход в ядро (Kernel Mode):**
    - Библиотечная функция использует инструкцию, такую как `syscall` (x86_64) или `int 0x80` (x86), для переключения процессора в режим ядра.
3. **Обработка вызова в ядре:**
    - Ядро получает номер вызова (например, через регистр процессора), обращается к таблице системных вызовов и выполняет нужную операцию.
4. **Выполнение операции:**
    - Ядро выполняет запрошенную операцию (например, чтение данных с диска).
5. **Возврат результата:**
    - Результат возвращается в программу, и процессор переключается обратно в пользовательский режим.

---

### Механизм работы на уровне процессора

#### Режимы работы процессора:

1. **Пользовательский режим (User Mode):**
    - Ограниченный доступ к ресурсам системы.
    - Программы не могут напрямую взаимодействовать с аппаратным обеспечением.
2. **Режим ядра (Kernel Mode):**
    - Полный доступ к аппаратным ресурсам и привилегированным инструкциям процессора.

#### Инструкция `syscall`:

- **Архитектура x86-64:** Использует инструкцию `syscall` для перехода в режим ядра.
- **Архитектура x86:** Использует прерывание `int 0x80` для выполнения системного вызова.
- Регистры процессора используются для передачи параметров вызова и возвращения результата.
    - Например, в x86-64:
        - `RAX` — номер системного вызова.
        - `RDI`, `RSI`, `RDX` — параметры вызова.
        - Результат возвращается в `RAX`.

---

### Механизм работы на уровне операционной системы

#### Таблица системных вызовов:

- Каждому системному вызову соответствует уникальный номер.
- ОС содержит таблицу системных вызовов (system call table), где каждый номер связывается с функцией-обработчиком в ядре.
    - Например:
        - Для вызова `read()` функцией-обработчиком может быть функция, которая выполняет чтение данных из файла.
        - Для вызова `fork()` — функция, создающая новый процесс.

#### Обработка системного вызова:

1. **Идентификация вызова:**
    - Ядро получает номер вызова из регистра (например, `RAX`) и находит соответствующую функцию в таблице системных вызовов.
2. **Проверка параметров:**
    - Проверяются переданные параметры на корректность и безопасность.
3. **Выполнение операции:**
    - Выполняется привилегированная операция (например, чтение файла или создание процесса).
4. **Возврат результата:**
    - Результат записывается в регистр (например, `RAX`) и возвращается в пользовательский режим.

---

### Примеры системных вызовов

#### 1. **Работа с файлами:**

- `open()` — открыть файл.
- `read()` — прочитать данные из файла.
- `write()` — записать данные в файл.
- `close()` — закрыть файл.

#### 2. **Управление процессами:**

- `fork()` — создать новый процесс.
- `execve()` — запустить новую программу в текущем процессе.
- `exit()` — завершить процесс.
- `wait()` — ожидать завершения дочернего процесса.

#### 3. **Взаимодействие с устройствами:**

- `ioctl()` — управление устройствами ввода-вывода.
- `mmap()` — отобразить файл или устройство в адресное пространство процесса.

#### 4. **Сигналы:**

- `kill()` — отправить сигнал процессу.
- `sigaction()` — установить обработчик сигнала.

---

### Оптимизация и безопасность

#### Оптимизация работы системных вызовов:

- **Буферизация:**
    - Системные вызовы, связанные с вводом-выводом, используют промежуточные области памяти (буферы). Это уменьшает количество непосредственных обращений к ядру.
    - Программа записывает данные в буфер, а ядро передаёт данные устройству одним блоком.

- **Сокращение количества вызовов:**
    - Например, чтение данных блоками вместо побайтового обращения.

#### Обеспечение безопасности:

- Проверка параметров на уровне ядра.
- Ограничение доступа к ресурсам (права доступа, управление пользователями).
- Логирование выполнения привилегированных операций.

---

### Итог
Системные вызовы обеспечивают безопасное и эффективное взаимодействие между прикладными программами и ядром ОС. Они позволяют управлять ресурсами, обеспечивать многозадачность и изоляцию процессов, а также повышают безопасность и производительность систем.
